<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Procesando pago - Gimnasio Veltronik">
    <title>Procesando Pago | Veltronik</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/components.css">

    <style>
        .callback-container {
            text-align: center;
            max-width: 500px;
        }

        .callback-icon {
            font-size: 5rem;
            margin-bottom: 1.5rem;
        }

        .callback-icon.loading {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.7;
            }
        }

        .callback-title {
            color: white;
            font-size: var(--font-size-2xl);
            margin-bottom: 1rem;
        }

        .callback-message {
            color: var(--gray-400);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .callback-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--primary-500);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .status-success {
            color: var(--success-500);
        }

        .status-error {
            color: var(--error-500);
        }

        .status-pending {
            color: var(--warning-500);
        }
    </style>

    <!-- Favicon -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèãÔ∏è</text></svg>">
</head>

<body>
    <div class="auth-wrapper">
        <div class="auth-container callback-container">
            <div class="auth-card">
                <!-- Loading State -->
                <div id="loadingState">
                    <div class="callback-spinner"></div>
                    <h1 class="callback-title">Verificando pago...</h1>
                    <p class="callback-message">
                        Por favor espera mientras confirmamos tu suscripci√≥n.
                    </p>
                </div>

                <!-- Success State (hidden by default) -->
                <div id="successState" style="display: none;">
                    <div class="callback-icon status-success">‚úÖ</div>
                    <h1 class="callback-title">¬°Pago Exitoso!</h1>
                    <p class="callback-message">
                        Tu suscripci√≥n ha sido activada correctamente.
                        Ser√°s redirigido al dashboard en unos segundos...
                    </p>
                    <a href="dashboard.html" class="btn btn-primary btn-lg" style="width: 100%;">
                        Ir al Dashboard
                    </a>
                </div>

                <!-- Pending State (hidden by default) -->
                <div id="pendingState" style="display: none;">
                    <div class="callback-icon status-pending">‚è≥</div>
                    <h1 class="callback-title">Pago Pendiente</h1>
                    <p class="callback-message">
                        Tu pago est√° siendo procesado. Te notificaremos cuando est√© confirmado.
                    </p>
                    <a href="dashboard.html" class="btn btn-secondary btn-lg" style="width: 100%;">
                        Continuar
                    </a>
                </div>

                <!-- Error State (hidden by default) -->
                <div id="errorState" style="display: none;">
                    <div class="callback-icon status-error">‚ùå</div>
                    <h1 class="callback-title">Pago No Procesado</h1>
                    <p class="callback-message">
                        Hubo un problema con tu pago. Por favor, intenta nuevamente.
                    </p>
                    <a href="plans.html" class="btn btn-primary btn-lg" style="width: 100%;">
                        Volver a Planes
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/auth.js"></script>

    <script>
        // Parse URL parameters from MP callback
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                collection_id: params.get('collection_id'),
                collection_status: params.get('collection_status'),
                payment_id: params.get('payment_id'),
                status: params.get('status'),
                external_reference: params.get('external_reference'),
                payment_type: params.get('payment_type'),
                merchant_order_id: params.get('merchant_order_id'),
                preference_id: params.get('preference_id'),
                site_id: params.get('site_id'),
                processing_mode: params.get('processing_mode'),
                merchant_account_id: params.get('merchant_account_id'),
                preapproval_id: params.get('preapproval_id')
            };
        }

        // Show specific state
        function showState(stateId) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('successState').style.display = 'none';
            document.getElementById('pendingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById(stateId).style.display = 'block';
        }

        // Check gym status periodically
        async function checkGymStatus(maxAttempts = 10) {
            for (let i = 0; i < maxAttempts; i++) {
                try {
                    const gym = await getGym();

                    if (gym && gym.status === 'active') {
                        return 'active';
                    }

                    // Wait 2 seconds before next check
                    await new Promise(resolve => setTimeout(resolve, 2000));

                } catch (error) {
                    console.error('Status check error:', error);
                }
            }
            return 'pending';
        }

        // Process callback
        async function processCallback() {
            const params = getUrlParams();

            console.log('Payment callback params:', params);

            // Determine initial status from URL params
            let status = params.status || params.collection_status;

            if (status === 'approved' || status === 'authorized') {
                // Check if gym is actually active (webhook may have processed)
                const gymStatus = await checkGymStatus(5);

                if (gymStatus === 'active') {
                    showState('successState');

                    // Redirect to dashboard after 3 seconds
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 3000);
                } else {
                    // Webhook might still be processing
                    showState('pendingState');
                }

            } else if (status === 'pending' || status === 'in_process') {
                showState('pendingState');

            } else if (status === 'rejected' || status === 'cancelled' || status === 'failure') {
                showState('errorState');

            } else {
                // No clear status, check directly
                const gymStatus = await checkGymStatus(10);

                if (gymStatus === 'active') {
                    showState('successState');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 3000);
                } else {
                    showState('pendingState');
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const session = await getSession();

                if (!session) {
                    window.location.href = CONFIG.ROUTES.LOGIN;
                    return;
                }

                await processCallback();

            } catch (error) {
                console.error('Callback error:', error);
                showState('errorState');
            }
        });
    </script>
</body>

</html>